// Prisma Schema for SEU Short Courses Platform
// Epic E1.1 — Catalog Foundation

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// USER & AUTH
// =============================================================================

enum UserRole {
  LEARNER
  CORPORATE_COORDINATOR  // B2B corporate clients
  OPERATIONS             // Internal operations staff
  FINANCE                // Internal finance staff
  ADMIN                  // Platform administrators
  INSTRUCTOR             // Course instructors
  PROGRAM_MANAGER        // Program managers
}

enum BlackboardProvisionStatus {
  NOT_PROVISIONED
  PENDING
  PROVISIONED
  FAILED
}

model User {
  id             String   @id @default(cuid())
  email          String   @unique
  passwordHash   String
  firstName      String
  lastName       String
  phone          String?
  nationalId     String?  @unique
  role           UserRole @default(LEARNER)
  organizationId String?
  isActive       Boolean  @default(true)
  emailVerified  Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Blackboard Integration
  blackboardUserId           String?                    @unique
  blackboardProvisionStatus  BlackboardProvisionStatus  @default(NOT_PROVISIONED)
  blackboardProvisionedAt    DateTime?
  blackboardProvisionError   String?

  organization           Organization?              @relation(fields: [organizationId], references: [id])
  registrations          Registration[]
  enrollments            Enrollment[]
  payments               Payment[]
  certificates           Certificate[]
  passwordResets         PasswordResetToken[]
  emailVerificationTokens EmailVerificationToken[]
  notifications          Notification[]
  auditLogs              AuditLog[]

  @@map("users")
}

// Password Reset Tokens - Production-ready token storage
model PasswordResetToken {
  id        String    @id @default(cuid())
  token     String    @unique
  userId    String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("password_reset_tokens")
}

// Email Verification Tokens - For verifying user email addresses
model EmailVerificationToken {
  id        String    @id @default(cuid())
  token     String    @unique
  userId    String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("email_verification_tokens")
}


// Audit Logs - Track admin actions for security and compliance
model AuditLog {
  id         String   @id @default(cuid())
  userId     String
  action     String
  resource   String
  resourceId String?
  details    String?  @db.Text
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([createdAt])
  @@map("audit_logs")
}

// =============================================================================
// CATALOG — CATEGORIES
// =============================================================================

model Category {
  id        String   @id @default(cuid())
  nameAr    String
  nameEn    String
  slug      String   @unique
  parentId  String?
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children Category[] @relation("CategoryHierarchy")
  programs Program[]

  @@map("categories")
}

// =============================================================================
// CATALOG — INSTRUCTORS
// =============================================================================

model Instructor {
  id        String   @id @default(cuid())
  nameAr    String
  nameEn    String
  titleAr   String
  titleEn   String
  bioAr     String?  @db.Text
  bioEn     String?  @db.Text
  imageUrl  String?
  email     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  cohorts  Cohort[]

  @@map("instructors")
}

// =============================================================================
// CATALOG — PROGRAMS
// =============================================================================

enum ProgramStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum ProgramType {
  COURSE
  WORKSHOP
  BOOTCAMP
  CERTIFICATION
}

enum DeliveryMode {
  ONLINE
  IN_PERSON
  HYBRID
}

model Program {
  id                 String        @id @default(cuid())
  titleAr            String
  titleEn            String
  descriptionAr      String
  descriptionEn      String
  shortDescriptionAr String
  shortDescriptionEn String
  slug               String        @unique
  type               ProgramType   @default(COURSE)
  deliveryMode       DeliveryMode  @default(ONLINE)
  durationHours      Int
  price              Decimal       @db.Decimal(10, 2)
  earlyBirdPrice     Decimal?      @db.Decimal(10, 2)
  corporatePrice     Decimal?      @db.Decimal(10, 2)
  currency           String        @default("SAR")
  status             ProgramStatus @default(DRAFT)
  categoryId         String
  imageUrl           String?
  prerequisitesAr    String?
  prerequisitesEn    String?
  learningOutcomesAr String[]      @default([])
  learningOutcomesEn String[]      @default([])
  targetAudienceAr   String?
  targetAudienceEn   String?
  blackboardCourseId String?
  isFeatured         Boolean       @default(false)
  sortOrder          Int           @default(0)
  
  // Certificate settings
  certificateEnabled          Boolean @default(true)
  certificateAttendanceThreshold Int  @default(80)
  
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  // Relations
  category    Category          @relation(fields: [categoryId], references: [id])
  cohorts     Cohort[]
  modules     ProgramModule[]

  @@index([status])
  @@index([categoryId])
  @@map("programs")
}

// =============================================================================
// CURRICULUM — MODULES & SESSIONS
// =============================================================================

model ProgramModule {
  id          String   @id @default(cuid())
  programId   String
  titleAr     String
  titleEn     String
  descriptionAr String? @db.Text
  descriptionEn String? @db.Text
  durationHours Int
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  program  Program  @relation(fields: [programId], references: [id], onDelete: Cascade)
  sessions Session[]

  @@index([programId])
  @@index([sortOrder])
  @@map("program_modules")
}

model Session {
  id          String   @id @default(cuid())
  moduleId    String
  titleAr     String
  titleEn     String
  descriptionAr String? @db.Text
  descriptionEn String? @db.Text
  durationMinutes Int
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  module ProgramModule @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  @@index([moduleId])
  @@index([sortOrder])
  @@map("sessions")
}

// =============================================================================
// COHORTS
// =============================================================================

enum CohortStatus {
  UPCOMING
  OPEN
  FULL
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model Cohort {
  id                    String       @id @default(cuid())
  programId             String
  instructorId          String?
  nameAr                String
  nameEn                String
  startDate             DateTime
  endDate               DateTime
  registrationStartDate DateTime
  registrationEndDate   DateTime
  capacity              Int
  enrolledCount         Int          @default(0)
  status                CohortStatus @default(UPCOMING)
  blackboardCourseId    String?      @unique
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt

  // Relations
  program       Program        @relation(fields: [programId], references: [id])
  instructor    Instructor?    @relation(fields: [instructorId], references: [id])
  registrations Registration[]
  enrollments   Enrollment[]
  certificates  Certificate[]

  @@index([programId])
  @@index([status])
  @@map("cohorts")
}

// =============================================================================
// REGISTRATIONS
// =============================================================================

enum RegistrationStatus {
  PENDING_PAYMENT
  PAYMENT_FAILED
  CONFIRMED
  CANCELLED
  REFUNDED
}

model Registration {
  id           String             @id @default(cuid())
  userId       String
  cohortId     String
  status       RegistrationStatus @default(PENDING_PAYMENT)
  registeredAt DateTime           @default(now())
  confirmedAt  DateTime?
  expiresAt    DateTime? // Seat hold expiration (15 minutes from registration)
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  // Relations
  user       User        @relation(fields: [userId], references: [id])
  cohort     Cohort      @relation(fields: [cohortId], references: [id])
  payment    Payment?
  enrollment Enrollment?

  @@index([userId, cohortId, status])
  @@index([status])
  @@index([expiresAt])
  @@map("registrations")
}

// =============================================================================
// ENROLLMENTS
// =============================================================================

enum EnrollmentStatus {
  PENDING
  ENROLLED
  IN_PROGRESS
  COMPLETED
  FAILED
  WITHDRAWN
}

model Enrollment {
  id                     String           @id @default(cuid())
  registrationId         String           @unique
  userId                 String
  cohortId               String
  status                 EnrollmentStatus @default(PENDING)
  blackboardEnrollmentId String?          @unique
  blackboardCourseId     String?
  blackboardRole         String?          // Student, Instructor, TeachingAssistant
  blackboardSyncStatus   String?          // PENDING, SYNCED, FAILED
  blackboardSyncError    String?
  blackboardSyncedAt     DateTime?
  progress               Int              @default(0) // 0-100 percentage
  completionStatus       String?          // NOT_STARTED, IN_PROGRESS, COMPLETED, FAILED
  completionPercentage   Int?             // From Blackboard
  lastActivityAt         DateTime?        // Last activity in Blackboard
  completedAt            DateTime?
  certificateEligible    Boolean          @default(false)
  createdAt              DateTime         @default(now())
  updatedAt              DateTime         @updatedAt

  // Relations
  registration Registration @relation(fields: [registrationId], references: [id])
  user         User         @relation(fields: [userId], references: [id])
  cohort       Cohort       @relation(fields: [cohortId], references: [id])
  certificate  Certificate?

  @@index([status])
  @@map("enrollments")
}

// =============================================================================
// PAYMENTS
// =============================================================================

enum PaymentMethod {
  CARD
  TABBY
  TAMARA
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

model Payment {
  id                    String        @id @default(cuid())
  registrationId        String        @unique
  userId                String
  amount                Decimal       @db.Decimal(10, 2)
  currency              String        @default("SAR")
  method                PaymentMethod
  status                PaymentStatus @default(PENDING)
  providerPaymentId     String?
  providerTransactionId String?
  paidAt                DateTime?
  refundedAt            DateTime?
  refundAmount          Decimal?      @db.Decimal(10, 2)
  metadata              Json?
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt

  // Relations
  registration Registration @relation(fields: [registrationId], references: [id])
  user         User         @relation(fields: [userId], references: [id])
  invoice      Invoice?

  @@index([status])
  @@map("payments")
}

model Invoice {
  id          String   @id @default(cuid())
  paymentId   String   @unique
  number      String   @unique
  amount      Decimal  @db.Decimal(10, 2)
  currency    String   @default("SAR")
  vatAmount   Decimal  @db.Decimal(10, 2)
  totalAmount Decimal  @db.Decimal(10, 2)
  issuedAt    DateTime @default(now())
  pdfUrl      String?
  createdAt   DateTime @default(now())

  // Relations
  payment Payment @relation(fields: [paymentId], references: [id])

  @@map("invoices")
}

// =============================================================================
// CERTIFICATES
// =============================================================================

enum CertificateStatus {
  PENDING
  ISSUED
  REVOKED
}

model Certificate {
  id                String            @id @default(cuid())
  enrollmentId      String            @unique
  userId            String
  cohortId          String
  number            String            @unique
  issuedAt          DateTime          @default(now())
  expiryDate        DateTime?
  status            CertificateStatus @default(PENDING)
  verificationCode  String            @unique @default(cuid())
  pdfUrl            String?
  revokedAt         DateTime?
  revocationReason  String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  // Relations
  enrollment Enrollment @relation(fields: [enrollmentId], references: [id])
  user       User       @relation(fields: [userId], references: [id])
  cohort     Cohort     @relation(fields: [cohortId], references: [id])

  @@index([verificationCode])
  @@map("certificates")
}

// =============================================================================
// PROMO CODES
// =============================================================================

enum PromoCodeType {
  PERCENTAGE
  FIXED_AMOUNT
}

model PromoCode {
  id          String        @id @default(cuid())
  code        String        @unique
  type        PromoCodeType @default(PERCENTAGE)
  value       Decimal       @db.Decimal(10, 2) // Percentage (0-100) or fixed amount
  maxUses     Int? // Null = unlimited
  usedCount   Int           @default(0)
  minPurchase Decimal?      @db.Decimal(10, 2) // Minimum order value
  maxDiscount Decimal?      @db.Decimal(10, 2) // Cap for percentage discounts
  programId   String? // If null, applies to all programs
  validFrom   DateTime      @default(now())
  validUntil  DateTime?
  isActive    Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relations
  usages PromoCodeUsage[]

  @@index([code])
  @@map("promo_codes")
}

model PromoCodeUsage {
  id             String   @id @default(cuid())
  promoCodeId    String
  registrationId String
  discountAmount Decimal  @db.Decimal(10, 2)
  usedAt         DateTime @default(now())

  // Relations
  promoCode PromoCode @relation(fields: [promoCodeId], references: [id])

  @@unique([promoCodeId, registrationId])
  @@map("promo_code_usages")
}

// =============================================================================
// WAITLIST
// =============================================================================

enum InvoiceStatus {
  DRAFT
  ISSUED
  PAID
  CANCELLED
  REFUNDED
}

enum NotificationType {
  REGISTRATION_CONFIRMATION
  PAYMENT_RECEIPT
  PAYMENT_FAILED
  BLACKBOARD_ACCESS
  SYSTEM_ALERT
  COURSE_REMINDER
  CERTIFICATE_READY
  ENROLLMENT_CONFIRMED
  COHORT_CANCELLED
  WAITLIST_AVAILABLE
  PASSWORD_RESET
  EMAIL_VERIFICATION
}

enum NotificationChannel {
  EMAIL
  SMS
  PUSH
  IN_APP
}

enum NotificationStatus {
  PENDING
  QUEUED
  PROCESSING
  SENT
  DELIVERED
  FAILED
  CANCELLED
}

enum NotificationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum WaitlistStatus {
  WAITING
  NOTIFIED
  CONVERTED
  EXPIRED
}

model WaitlistEntry {
  id         String         @id @default(cuid())
  userId     String
  cohortId   String
  position   Int
  status     WaitlistStatus @default(WAITING)
  notifiedAt DateTime?
  expiresAt  DateTime? // Deadline to register after notification
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt

  @@unique([userId, cohortId])
  @@index([cohortId, position])
  @@index([status])
  @@map("waitlist_entries")
}

// =============================================================================
// NOTIFICATIONS
// =============================================================================

model Notification {
  id     String  @id @default(cuid())
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type     NotificationType
  channel  NotificationChannel
  status   NotificationStatus   @default(PENDING)
  priority NotificationPriority @default(NORMAL)

  recipient    String // Email or phone number
  subject      String? // For emails
  templateId   String
  templateData Json // Dynamic data for template
  locale       String  @default("ar")

  scheduledAt DateTime? // For scheduled notifications
  sentAt      DateTime?
  deliveredAt DateTime?
  failedAt    DateTime?

  retryCount Int     @default(0)
  maxRetries Int     @default(3)
  lastError  String?

  metadata Json? // Additional tracking data

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  logs NotificationLog[]

  @@index([userId])
  @@index([status])
  @@index([type])
  @@index([scheduledAt])
  @@index([createdAt])
  @@map("notifications")
}

model NotificationLog {
  id             String       @id @default(cuid())
  notificationId String
  notification   Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)

  status       NotificationStatus
  message      String?
  errorDetails Json?

  timestamp DateTime @default(now())

  @@index([notificationId])
  @@index([timestamp])
  @@map("notification_logs")
}

// =============================================================================
// ORGANIZATIONS (B2B)
// =============================================================================

model Organization {
  id           String   @id @default(cuid())
  nameAr       String
  nameEn       String
  crNumber     String?
  vatNumber    String?
  contactEmail String
  contactPhone String?
  address      String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  users User[]

  @@map("organizations")
}
