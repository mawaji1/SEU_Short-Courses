# خطوات النشر اليدوية - تكامل الدفع

## نظرة عامة
يوضح هذا المستند جميع الخطوات اليدوية المطلوبة لإكمال نشر تكامل الدفع. تم إكمال جميع أعمال البرمجة. تتضمن هذه الخطوات التكوين والتسجيل والاختبار.

**الوقت الإجمالي المقدر:** 6-8 ساعات

---

## المتطلبات الأساسية

### الحسابات وبيانات الاعتماد المطلوبة
- ✅ حساب تاجر في Moyasar
- ✅ حساب تاجر في Tabby
- ✅ حساب تاجر في Tamara
- ✅ الوصول إلى خوادم الإنتاج
- ✅ الوصول إلى قاعدة البيانات

### المعلومات المطلوبة
- رابط الخادم الخلفي (الإنتاج)
- رابط الموقع الأمامي (الإنتاج)
- مفاتيح API لجميع مزودي الخدمة (تجريبي وحقيقي)

---

## الخطوة 1: إعداد متغيرات البيئة (30 دقيقة)

### متغيرات البيئة للخادم الخلفي

إنشاء/تحديث ملف `.env` في الخادم الخلفي:

```env
# إعدادات Moyasar
MOYASAR_SECRET_KEY=sk_live_xxxxxxxxxx
MOYASAR_PUBLISHABLE_KEY=pk_live_xxxxxxxxxx

# إعدادات Tabby
TABBY_API_URL=https://api.tabby.ai/api/v2
TABBY_SECRET_KEY=sk_live_xxxxxxxxxx
TABBY_PUBLIC_KEY=pk_live_xxxxxxxxxx
TABBY_MERCHANT_CODE=your_merchant_code
TABBY_MIN_AMOUNT=100
TABBY_MAX_AMOUNT=10000

# إعدادات Tamara
TAMARA_API_URL=https://api.tamara.co
TAMARA_API_TOKEN=your_api_token
TAMARA_NOTIFICATION_TOKEN=your_notification_token
TAMARA_MIN_AMOUNT=100
TAMARA_MAX_AMOUNT=10000

# روابط التطبيق
FRONTEND_URL=https://your-domain.com
BACKEND_URL=https://api.your-domain.com
```

### متغيرات البيئة للموقع الأمامي

إنشاء/تحديث ملف `.env.local` في الموقع الأمامي:

```env
# Moyasar
NEXT_PUBLIC_MOYASAR_PUBLISHABLE_KEY=pk_live_xxxxxxxxxx

# Tabby
NEXT_PUBLIC_TABBY_PUBLIC_KEY=pk_live_xxxxxxxxxx
NEXT_PUBLIC_TABBY_MERCHANT_CODE=your_merchant_code

# Tamara
NEXT_PUBLIC_TAMARA_PUBLIC_KEY=your_public_key
```

**مهم:** لا تقم برفع هذه الملفات إلى نظام التحكم في الإصدارات!

---

## الخطوة 2: تسجيل Webhooks (30 دقيقة)

### 2.1 تسجيل Webhook في Moyasar

**الطريقة:** لوحة التحكم

1. **تسجيل الدخول إلى لوحة تحكم Moyasar**
   - الرابط: https://dashboard.moyasar.com
   - استخدم بيانات اعتماد التاجر

2. **الانتقال إلى Webhooks**
   - انقر على "الإعدادات" في الشريط الجانبي
   - انقر على "Webhooks"

3. **إضافة Webhook جديد**
   - انقر على "إضافة Webhook" أو "Create Webhook"
   - **الرابط:** `https://api.your-domain.com/api/payments/webhook`
   - **الأحداث المطلوبة:**
     - ✅ payment_paid
     - ✅ payment_failed
     - ✅ payment_refunded

4. **الحفظ والاختبار**
   - انقر على "حفظ"
   - استخدم زر "اختبار" للتحقق من إمكانية الوصول
   - تحقق من سجلات الخادم لاستلام webhook التجريبي

**التحقق:**
```bash
# فحص سجلات الخادم
tail -f /var/log/app.log | grep "Moyasar webhook"
```

---

### 2.2 تسجيل Webhook في Tabby

**الطريقة:** استدعاء API

1. **تحضير طلب API**

```bash
curl -X POST https://api.tabby.ai/api/v2/webhooks \
  -H "Authorization: Bearer YOUR_SECRET_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "url": "https://api.your-domain.com/api/payments/webhooks/tabby",
    "is_test": false,
    "merchant_code": "YOUR_MERCHANT_CODE"
  }'
```

2. **تنفيذ الطلب**
   - استبدل `YOUR_SECRET_KEY` بالمفتاح السري الفعلي
   - استبدل `YOUR_MERCHANT_CODE` برمز التاجر الفعلي
   - اضبط `is_test: false` للإنتاج
   - اضبط `is_test: true` للاختبار

3. **حفظ الاستجابة**
   - ستحتوي الاستجابة على معرف webhook
   - احفظه للرجوع إليه مستقبلاً

4. **إضافة عناوين IP الخاصة بـ Tabby إلى القائمة البيضاء (اختياري لكن موصى به)**

أضف هذه العناوين إلى جدار الحماية/مجموعة الأمان:
```
34.166.36.90
34.166.35.211
34.166.34.222
34.166.37.207
34.93.76.191
```

**التحقق:**
```bash
# اختبر بدفعة حقيقية
# تحقق من السجلات لاستلام webhook
tail -f /var/log/app.log | grep "Tabby webhook"
```

---

### 2.3 تسجيل Webhook في Tamara

**الطريقة:** بوابة الشركاء

1. **تسجيل الدخول إلى بوابة شركاء Tamara**
   - الرابط: https://partners.tamara.co
   - استخدم بيانات اعتماد التاجر

2. **الانتقال إلى Webhooks**
   - انقر على "Webhooks" في الشريط الجانبي الأيسر
   - انقر على زر "Add webhooks"

3. **تكوين Webhook**
   - **النوع:** Order
   - **الأحداث:** اختر على الأقل:
     - ✅ Approved (مطلوب)
     - ✅ Authorized
     - ✅ Declined
     - ✅ Expired
   - **الرابط:** `https://api.your-domain.com/api/payments/webhooks/tamara`
   - **الرؤوس:** (اختياري) أضف رؤوس مخصصة إذا لزم الأمر

4. **الحصول على رمز الإشعار**
   - بعد إنشاء webhook، انسخ "Notification Token"
   - أضفه إلى `.env` في الخادم الخلفي كـ `TAMARA_NOTIFICATION_TOKEN`

5. **حفظ التكوين**
   - انقر على "Create Webhook"
   - تحقق من ظهور webhook في القائمة

**التحقق:**
```bash
# فحص سجلات الخادم
tail -f /var/log/app.log | grep "Tamara webhook"
```

---

## الخطوة 3: إضافة الودجات إلى صفحات الموقع (2-3 ساعات)

### 3.1 صفحة تفاصيل المنتج

**الملف:** `frontend/src/app/courses/[id]/page.tsx`

**إضافة الاستيرادات:**
```typescript
import { TabbyPromoWidget, TamaraWidget } from '@/components/payment';
```

**إضافة الودجات بالقرب من عرض السعر:**
```tsx
{/* عرض السعر */}
<div className="text-3xl font-bold">
  {program.price} ريال
</div>

{/* ودجات BNPL */}
<div className="space-y-2 mt-4">
  <TabbyPromoWidget 
    price={program.price} 
    currency="SAR" 
    language="ar" 
    source="product" 
  />
  
  <TamaraWidget 
    price={program.price} 
    currency="SAR" 
    language="ar" 
    widgetType="product-widget" 
  />
</div>
```

---

### 3.2 صفحة السلة

**الملف:** `frontend/src/app/cart/page.tsx`

**إضافة الاستيرادات:**
```typescript
import { TabbyPromoWidget, TamaraWidget } from '@/components/payment';
```

**إضافة الودجات بالقرب من إجمالي السلة:**
```tsx
{/* إجمالي السلة */}
<div className="text-2xl font-bold">
  الإجمالي: {cartTotal} ريال
</div>

{/* ودجات BNPL */}
<div className="space-y-2 mt-4">
  <TabbyPromoWidget 
    price={cartTotal} 
    currency="SAR" 
    language="ar" 
    source="cart" 
  />
  
  <TamaraWidget 
    price={cartTotal} 
    currency="SAR" 
    language="ar" 
    widgetType="cart-widget" 
  />
</div>
```

---

### 3.3 صفحة الدفع

**الملف:** `frontend/src/app/checkout/page.tsx`

**إضافة الاستيرادات:**
```typescript
import { TabbyCheckoutWidget, TamaraWidget } from '@/components/payment';
```

**إضافة الودجات بالقرب من خيارات الدفع:**
```tsx
{/* قسم خيارات الدفع */}
<div className="payment-section">
  <h3>طرق الدفع</h3>
  
  {/* ودجات BNPL */}
  <div className="space-y-2 mb-4">
    <TabbyCheckoutWidget 
      price={orderTotal} 
      currency="SAR" 
      language="ar" 
    />
    
    <TamaraWidget 
      price={orderTotal} 
      currency="SAR" 
      language="ar" 
      widgetType="checkout-widget" 
    />
  </div>
  
  {/* خيارات الدفع الموجودة */}
  <PaymentOptions />
</div>
```

---

## الخطوة 4: الاختبار (3-4 ساعات)

### 4.1 اختبار Moyasar

**بطاقات الاختبار:**
- نجاح: `4111 1111 1111 1111`
- فشل: `4000 0000 0000 0002`

**سيناريوهات الاختبار:**
1. ✅ إنشاء دفعة
2. ✅ إكمال 3D Secure
3. ✅ التحقق من استلام webhook
4. ✅ فحص حالة الدفع في قاعدة البيانات
5. ✅ اختبار الاسترداد (كامل وجزئي)

**قائمة التحقق:**
- [ ] تم إنشاء الدفعة بنجاح
- [ ] تم استلام ومعالجة webhook
- [ ] تم تحديث حالة الدفع إلى COMPLETED
- [ ] تم تحديث حالة التسجيل إلى CONFIRMED
- [ ] تم إرسال إيصال البريد الإلكتروني
- [ ] تم زيادة عدد المسجلين

---

### 4.2 اختبار Tabby

**بيانات الاختبار:** استخدم بيئة اختبار Tabby

**سيناريوهات الاختبار:**
1. ✅ فحص الأهلية (pre-scoring)
2. ✅ إنشاء جلسة الدفع
3. ✅ إكمال الدفع في Tabby
4. ✅ التحقق من webhook "authorized"
5. ✅ التحقق من الالتقاط التلقائي
6. ✅ فحص حالة الدفع

**قائمة التحقق:**
- [ ] فحص الأهلية يعمل
- [ ] تم إنشاء جلسة الدفع
- [ ] إعادة التوجيه إلى Tabby تعمل
- [ ] تم استلام webhook (authorized)
- [ ] تم التقاط الدفعة تلقائياً
- [ ] تم تحديث حالة الدفع
- [ ] تم تأكيد التسجيل
- [ ] تم إرسال البريد الإلكتروني

---

### 4.3 اختبار Tamara

**بيانات الاختبار:** استخدم بيئة sandbox في Tamara

**سيناريوهات الاختبار:**
1. ✅ إنشاء جلسة الدفع
2. ✅ إكمال الدفع في Tamara
3. ✅ التحقق من webhook "approved"
4. ✅ التحقق من استدعاء API للتفويض
5. ✅ فحص حالة الدفع

**قائمة التحقق:**
- [ ] تم إنشاء جلسة الدفع مع الأقساط الصحيحة
- [ ] إعادة التوجيه إلى Tamara تعمل
- [ ] تم استلام webhook (approved)
- [ ] تم استدعاء API للتفويض بنجاح
- [ ] تم تحديث حالة الدفع
- [ ] تم تأكيد التسجيل
- [ ] تم إرسال البريد الإلكتروني

**مهم جداً:** تحقق من حدوث التفويض تلقائياً بعد webhook "approved"!

---

### 4.4 اختبار الودجات

**الاختبار على جميع الصفحات:**

1. **صفحة المنتج**
   - [ ] تظهر ودجة Tabby
   - [ ] تظهر ودجة Tamara
   - [ ] تعرض الودجات السعر الصحيح
   - [ ] تتحدث الودجات عند تغيير السعر
   - [ ] تعمل باللغتين العربية والإنجليزية

2. **صفحة السلة**
   - [ ] تظهر الودجات
   - [ ] تعرض الودجات إجمالي السلة الصحيح
   - [ ] تتحدث الودجات عند تغيير السلة

3. **صفحة الدفع**
   - [ ] تظهر ودجات الدفع
   - [ ] تعرض الودجات إجمالي الطلب الصحيح
   - [ ] الودجات متجاوبة مع الأجهزة المختلفة

---

## الخطوة 5: إعداد المراقبة (ساعة واحدة)

### 5.1 سجلات التطبيق

**راقب هذه السجلات:**
```bash
# سجلات خدمة الدفع
tail -f /var/log/app.log | grep "Payment"

# سجلات webhook
tail -f /var/log/app.log | grep "webhook"

# سجلات الأخطاء
tail -f /var/log/app.log | grep "ERROR"
```

### 5.2 المقاييس المطلوب تتبعها

**المقاييس التقنية:**
- معدل نجاح الدفع (الهدف: >95%)
- معدل استلام webhook (الهدف: >99%)
- وقت استجابة API (الهدف: <2 ثانية)
- وقت تحميل الودجات (الهدف: <1 ثانية)

**المقاييس التجارية:**
- معدل التحويل حسب طريقة الدفع
- متوسط قيمة الطلب
- معدل التخلي عن السلة
- معدل اعتماد BNPL

### 5.3 التنبيهات

**إعداد تنبيهات لـ:**
- فشل استلام webhook
- فشل التحقق من الدفع
- أخطاء API (4xx، 5xx)
- مشاكل الاتصال بقاعدة البيانات

---

## الخطوة 6: النشر في الإنتاج (ساعة واحدة)

### 6.1 قائمة التحقق قبل النشر

- [ ] تم تعيين جميع متغيرات البيئة
- [ ] تم تسجيل جميع webhooks
- [ ] تم إضافة جميع الودجات إلى الصفحات
- [ ] نجحت جميع الاختبارات
- [ ] تم تشغيل ترحيلات قاعدة البيانات
- [ ] تم إنشاء نسخة احتياطية

### 6.2 خطوات النشر

1. **نشر الخادم الخلفي**
   ```bash
   # البناء
   npm run build
   
   # النشر
   pm2 restart app
   
   # التحقق
   curl https://api.your-domain.com/health
   ```

2. **نشر الموقع الأمامي**
   ```bash
   # البناء
   npm run build
   
   # النشر
   # (يعتمد على الاستضافة الخاصة بك)
   
   # التحقق
   curl https://your-domain.com
   ```

3. **التحقق من Webhooks**
   - إنشاء دفعة تجريبية لكل مزود
   - التحقق من استلام webhooks
   - فحص السجلات بحثاً عن أي أخطاء

### 6.3 التحقق بعد النشر

**اختبارات سريعة:**
1. زيارة صفحة المنتج ← رؤية الودجات
2. إضافة إلى السلة ← رؤية الودجات في السلة
3. الذهاب إلى الدفع ← رؤية ودجات الدفع
4. إنشاء دفعة تجريبية (مبلغ صغير)
5. التحقق من استلام webhook
6. فحص قاعدة البيانات لسجل الدفع
7. التحقق من إرسال البريد الإلكتروني

---

## الخطوة 7: قائمة التحقق النهائية

### التحقق النهائي

- [ ] جميع متغيرات البيئة صحيحة (مفاتيح حقيقية)
- [ ] جميع webhooks مسجلة (روابط الإنتاج)
- [ ] جميع الودجات تعرض بشكل صحيح
- [ ] اكتملت دفعة تجريبية بنجاح لكل مزود
- [ ] webhooks تستلم بنجاح
- [ ] إشعارات البريد الإلكتروني تعمل
- [ ] المراقبة والتنبيهات نشطة
- [ ] تم تدريب الفريق على النظام الجديد
- [ ] وثائق الدعم جاهزة

### خطة التراجع

في حالة حدوث مشاكل:
1. تعطيل طرق الدفع الجديدة في الواجهة
2. العودة إلى الإصدار السابق
3. التحقيق في المشاكل
4. الإصلاح وإعادة النشر

---

## جهات الاتصال للدعم

### Moyasar
- لوحة التحكم: https://dashboard.moyasar.com
- الدعم: [email protected]
- الهاتف: 800 1111848

### Tabby
- لوحة التحكم: https://merchant.tabby.ai/
- دعم التكامل: [email protected]
- الدعم التقني: [email protected]

### Tamara
- بوابة الشركاء: https://partners.tamara.co
- الدعم: عبر بوابة الشركاء

---

## استكشاف الأخطاء وإصلاحها

### عدم استلام Webhook

**تحقق من:**
1. الرابط صحيح ويمكن الوصول إليه
2. HTTPS مفعل
3. جدار الحماية يسمح بعناوين IP للمزود
4. الخادم يعمل
5. السجلات بحثاً عن أخطاء

**الحل:**
```bash
# اختبر النقطة يدوياً
curl -X POST https://api.your-domain.com/api/payments/webhook \
  -H "Content-Type: application/json" \
  -d '{"test": true}'
```

### الودجة لا تظهر

**تحقق من:**
1. تم تحميل السكريبت بشكل صحيح
2. المفتاح العام صحيح
3. السعر صالح
4. وحدة التحكم بحثاً عن أخطاء JavaScript

**الحل:**
- افتح وحدة تحكم المتصفح
- تحقق من أخطاء تحميل السكريبت
- تحقق من متغيرات البيئة

### فشل التحقق من الدفع

**تحقق من:**
1. مفاتيح API صحيحة
2. المبلغ متطابق
3. العملة متطابقة
4. معرف الدفع موجود

**الحل:**
- فحص السجلات للخطأ المحدد
- التحقق من وجود الدفعة في لوحة تحكم المزود
- فحص قاعدة البيانات لسجل الدفع

---

## قائمة التحقق من الإكمال

### التكوين
- [ ] تم تعيين متغيرات البيئة (الخادم الخلفي)
- [ ] تم تعيين متغيرات البيئة (الموقع الأمامي)
- [ ] تم تكوين قاعدة البيانات

### Webhooks
- [ ] تم تسجيل webhook في Moyasar
- [ ] تم تسجيل webhook في Tabby
- [ ] تم تسجيل webhook في Tamara
- [ ] تم اختبار جميع webhooks

### الموقع الأمامي
- [ ] تم إضافة الودجات إلى صفحة المنتج
- [ ] تم إضافة الودجات إلى صفحة السلة
- [ ] تم إضافة الودجات إلى صفحة الدفع
- [ ] تم اختبار الودجات على جميع الصفحات

### الاختبار
- [ ] نجح اختبار Moyasar الشامل
- [ ] نجح اختبار Tabby الشامل
- [ ] نجح اختبار Tamara الشامل
- [ ] جميع الودجات تعرض بشكل صحيح

### المراقبة
- [ ] تم تكوين السجلات
- [ ] تم إعداد تتبع المقاييس
- [ ] تم تكوين التنبيهات

### النشر
- [ ] تم نشر الخادم الخلفي
- [ ] تم نشر الموقع الأمامي
- [ ] نجحت اختبارات الإنتاج السريعة

### التوثيق
- [ ] تم تدريب الفريق
- [ ] وثائق الدعم جاهزة
- [ ] تم توثيق خطة التراجع

---

## الجدول الزمني المقدر

| المهمة | الوقت | الحالة |
|--------|-------|--------|
| إعداد البيئة | 30 دقيقة | ⏳ |
| تسجيل Webhook | 30 دقيقة | ⏳ |
| تكامل الودجات | 2-3 ساعات | ⏳ |
| الاختبار | 3-4 ساعات | ⏳ |
| إعداد المراقبة | ساعة واحدة | ⏳ |
| النشر | ساعة واحدة | ⏳ |
| **الإجمالي** | **6-8 ساعات** | ⏳ |

---

## معايير النجاح

✅ جميع مزودي الدفع الثلاثة يعملون في الإنتاج  
✅ webhooks تستلم بنجاح (معدل >99%)  
✅ الودجات تعرض على جميع الصفحات  
✅ معدل نجاح الدفع >95%  
✅ لا توجد أخطاء حرجة في السجلات  
✅ إشعارات البريد الإلكتروني تعمل  
✅ المراقبة والتنبيهات نشطة  

---

**إصدار الوثيقة:** 1.0  
**آخر تحديث:** 11 يناير 2026  
**المراجعة التالية:** بعد نشر الإنتاج
